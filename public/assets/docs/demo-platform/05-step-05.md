 ## âœ… Expected Outcome for this step
- A functioning FGA client in your app.
- A working function to generate/check account permissions.
- Accounts with appropriate tuples.
- *You should be able to ask AIya for your account information and actually see results*.

*Let's get started!*

---

## Add FGA Client
In this section we will expand the existing code found in `lib/auth0/fga/client.ts`. Before we open the code, you'll need to add the OpenFGA package:

```bash
pnpm add @openfga/sdk
```
Great! Go ahead and open `lib/auth0/fga/client.ts`.

You will notice some of the code has already been written for you, but there is a lot missing! Read through the comments and existing code and fill in the blanks.

If you need some assistance or are not sure what to write, go ahead and ask AIya for a hint or help.

> [!TIP]
> Don't forget to import the package you just installed!
>
> *Hint*: You will also probably need to import the `ClientConfiguration` *type*.

## Add getAccountPermissions

> [!IMPORTANT]
> If you're seeing `Success! FGA client initialized` in the console then great job! ðŸ‘ ðŸŽ‰
>
> If not... check in with AIya (or a lab attendant) to see where things may have gone awry.

Now we are going to move on to `lib/auth0/fga/get-account-permissions.ts`. In this file you will complete the code necessary to:

1. actually call FGA;
2. check what the user is permitted to do;
3. add the retrieved permissions to the API response.

> [!TIP]
> You will want to make sure and check for the following permissions:
>
> ```typescript
> [
>  "can_view",
>  "can_view_balances",
>  "can_view_transactions",
>  "can_transfer"
> ]
> ```
>
> *However*, if you want to see how things work maybe leave one or two off and see what happens!
>
> Â¯\\\_(ãƒ„)_/Â¯

> [!TIP]
> In addition to asking AIya for your account information you can also click on `Accounts` in the sidebar to do things _the old fashion way_. ðŸ™„
>
> ![Sidebar Account Menu](./assets/images/sidebar-accounts.png)

## Pulse Check
Have you been able to successfully fetch account data? ðŸ˜¬

#### _That's ok!_ It's still doing *exactly what it should be doing.*

We need tuples!

Normally when an account is created (or permissions modified in other ways) the permissions would be set as tuples in FGA. To save time, we've created a shortcut for you. Go ahead and open the 'dev tools' menu (right-side of app) and click on **Reset Account Permissions*.

![Reset Permissions](./assets/images/dev-tools-reset-permissions.png)

ðŸ¥ ***drum roll please...*** ðŸ¥ ðŸŽ‰ Accounts! ðŸŽ‰

If not, you know the drill... check with AIya or a lab attendant to get some assistance.

> [!TIP]
> If you are successfully seeing account information, but it is not complete (see the following image) then you *may not be checking for permissions correctly*.
>
> At least you get to preview what it looks like when `can_view_balances` is not granted! :D
>
> ![Reset Permissions](./assets/images/account-summary-hidden.png)

## Recap

### In this step you:
- [x] Installed and initialized the OpenFGA (Auth0 FGA) client.
- [x] Implemented permission retrieval (`getAccountPermissions`) to check: `can_view`, `can_view_balances`, `can_view_transactions`, `can_transfer`.
  - [x] Attached those permissions to the account API response so both the UI and AIya can respect them.
- [x] Seeded relationship tuples via the Dev Tools shortcut (Reset Account Permissions).
- [x] Verified behavior when specific permissions are missing (e.g. balances or transactions hidden).
- [x] Confirmed that no data is returned until valid tuples exist (_secure by default_).

### Quick selfâ€‘check:
- Do you see account rows after seeding tuples?
- Does hiding one permission (e.g. omit `can_view_balances`) remove only that portion of the UI / AI response?
- Does AIya refrain from *hallucinating* missing data?

### Key takeaway
- Fine-Grained Authorization sits *directly* in the RAG augmentation layer.
- Retrieval of account data is itself â€œRAG,â€ even though no vector database was involved.
- You grounded the AI (*and UI*) in only what the user is permitted to view -- no leaking data!

### Next up
Youâ€™ll build on these permissions to enforce more nuanced capabilities (e.g. transfers, transaction visibility) and now have the know-how to apply the same pattern to *other* retrieval tools -- let your imagination run wild!

### Proceed when:
âœ… FGA client logs â€œSuccessâ€

âœ… Accounts appear after reset

âœ… Permission toggles behave as expected

*If any item is failing, revisit:*
- Environment variables
- Client initialization
- The specific FGA check calls you implemented
- Tuple seeding

> [!TIP]
> Don't forget, you can always ask AIya for help!

### *Onward to the next step!*